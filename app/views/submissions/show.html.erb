<% content_for :title, "Submission" %>
<%= stylesheet_link_tag "submission" %>

<% if @submission.judge_output == nil || @submission.score == nil %>
  <p>
  <b> This submission has not finished judging. Refresh this page in a minute or two to see the submission's score.
  </b>
  </p>
<p>
  <%= link_to "Rejudge", rejudge_submission_path(@submission), :data => { :confirm => 'Are you sure?' }, :method => "post" if permitted_to? :rejudge, @submission %>
<% else %>
  <div id="submission_judged" class="score_<%= (@submission.score/10).to_i %>x">
    <%= @submission.score %>% - <%= case
                                   when @submission.score == 100; "All done. Nice."
                                   when @submission.score >= 80; "Close, but not quite."
                                   when @submission.score >= 40; "There's room for improvement"
                                   else; "Sorry, try again."
                                   end
                               %>
  </div>
  </p>
  <%= link_to "Rejudge", rejudge_submission_path(@submission), :data => { :confirm => 'Are you sure?' }, :method => "post" if permitted_to? :rejudge, @submission %>
<% end %>

<p>
<b>Problem:</b>
<%= link_to @submission.problem.title, @submission.problem %>
</p>

<p>
<b>Language:</b>
<%= @submission.language.name %>
</p>

<p>
<b>Score:</b>
<%= @submission.score %>
</p>

<p>
<b>User:</b>
<%= @submission.user.username %>
</p>

<% if @submission.judge_output != nil && @submission.score != nil %>

  <% if current_user.is_admin? %>
  <% @judge_data = @submission.judge_data %>
  <table class="results">
    <% if @judge_data.compiled? %>
      <tbody class="compilation status_<%= @judge_data.compilation.status %>">
        <tr>
          <th class="compile_command" colspan="3">Compilation: <span class="code"><%= @judge_data.compilation.command %></span></th>
          <th class="compile_status"><%= @judge_data.compilation.judgement %></th>
          <th>&nbsp;</th>
        </tr>
        <tr>
          <td colspan="5"><span class="code"><%= pp @judge_data.compilation.log %></span></td>
        </tr>
      </tbody>
    <% end %>
  </table>
  &nbsp;
  <table class="results">
    <% if !@judge_data.compiled? || @judge_data.compilation.status == :success %>
      <tbody class="headings">
        <th class="test_name"></th>
        <th>Time</th>
        <th>Memory</th>
        <th>Result</th>
        <th>Score</th>
      </tbody>
      <% @judge_data.test_sets.each_with_index do |(id, set_data), index| %>
        <tbody class="test_set status_<%= set_data.status %>">
          <tr>
            <th class="test_name">Test Set #<%= index+1 %></th>
            <th colspan="3">&nbsp;</th>
            <th class="judgement"><%= set_data.judgement %></th>
          </tr>
          <% set_data.test_cases.each_with_index do |(case_id, case_data), index| %>
            <tr class="test_case status_<%= case_data.status %>">
              <td class="test_name">Test Case #<%= index+1 %></td>
              <td class="test_time"><%= case_data.time %></td>
              <td class="test_memory"><%= case_data.meta.memory %></td>
              <td class="judgement"><%= case_data.judgement %></td>
              <td></td>
            </tr>
            <% if permitted_to? :inspect, @submission %>
              <tr class="inspect_test">
                <td colspan="5">
                  <table>
                    <tr><th>Actual Output</th><th>Expected Output</th><th>Evaluator Log</th></tr>
                    <tr>
                      <td><span class="code"><%= case_data.output %></span></td>
                      <td><span class="code"><%= Judge.truncate_output(@submission.problem.test_cases.find(case_id).output) %></span></td>
                      <td><%= case_data.evaluator.info %></td>
                    </tr>
                  </table>
                </td>
              </tr>
          <% end %>
          <% end %>
        </tbody>
      <% end %>
    <% end %>
    <tbody class="summary status_<%= @judge_data.status %> score_<%= (@judge_data.score/10).floor if !@judge_data.score.nil? %>x">
      <tr>
        <th colspan="3"></th>
        <th>Total&nbsp;Score:</th>
        <th class="judgement"><%= @judge_data.judgement %></th>
      </tr>
    </tbody>
  </table>
  <% end %>

  <p>
  <div class="submission_details">
    <b>Detailed Output:</b>
    <div class="submission_details_hider">
      <%= simple_format(@submission.judge_output, {}, :sanitize => false) %>
    </div>
    <div class="submission_details_prompt"></div>
  </div>
  </p>


  <% if current_user.is_admin? %>
  <%= simple_format(@submission.debug_output) %>
  <% end %>

<% end %>
<p>
<b>Source:</b>
<pre><%= @submission.source %></pre>
</p>

<%= link_to 'Edit', edit_submission_path(@submission) if permitted_to? :edit, @submission %> 
<%= link_to 'Back', @submission.problem %>
